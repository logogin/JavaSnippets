<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd">
  <modelVersion>4.0.0</modelVersion>
  <parent>
    <groupId>logogin</groupId>
    <artifactId>parent-pom</artifactId>
    <version>1</version>
  </parent>

  <artifactId>app-cache</artifactId>
  <version>1.0.0</version>
  <packaging>jar</packaging>
  <name>App :: Cache</name>

  <properties>
  </properties>

  <scm>
  </scm>

  <dependencies>
  </dependencies>

  <build>
    <plugins>
      <plugin>
        <groupId>org.apache.maven.plugins</groupId>
        <artifactId>maven-release-plugin</artifactId>
        <configuration>
          <goals>deploy</goals>
          <arguments>-Prelease</arguments>
        </configuration>
      </plugin>
      <plugin>
        <groupId>org.apache.maven.plugins</groupId>
        <artifactId>maven-surefire-plugin</artifactId>
        <configuration>
          <excludedGroups>integration</excludedGroups>
        </configuration>
      </plugin>
      <plugin>
        <artifactId>maven-failsafe-plugin</artifactId>
        <configuration>
          <includes>
            <include>**/*Test.java</include>
            <include>**/*IT.java</include>
          </includes>
          <groups>db,it</groups>
        </configuration>
        <executions>
          <execution>
            <goals>
              <goal>integration-test</goal>
              <goal>verify</goal>
            </goals>
          </execution>
        </executions>
      </plugin>
    </plugins>
  </build>

  <profiles>
    <profile>
      <id>release</id>
      <build>
        <plugins>
          <plugin>
            <groupId>org.codehaus.mojo</groupId>
            <artifactId>appassembler-maven-plugin</artifactId>
            <configuration>
              <daemons>
                <daemon>
                  <id>cache</id>
                  <mainClass>logogin.app.cache.Main</mainClass>
                  <jvmSettings>
                    <maxMemorySize>2048</maxMemorySize>
                    <maxStackSize>100</maxStackSize>
                    <extraArguments>
                      <extraArgument>
                        -Dnet.spy.log.LoggerImpl=net.spy.memcached.compat.log.Log4JLogger
                      </extraArgument>
                    </extraArguments>
                  </jvmSettings>

                  <platforms>
                    <platform>jsw</platform>
                  </platforms>
                  <generatorConfigurations>
                    <generatorConfiguration>
                      <generator>jsw</generator>
                      <includes>
                        <include>linux-x86-32</include>
                        <include>linux-x86-64</include>
                      </includes>
                      <configuration>
                        <property>
                          <name>wrapper.console.loglevel</name>
                          <value>INFO</value>
                        </property>
                        <property>
                          <name>wrapper.logfile</name>
                          <value>%APP_BASE%/../../logs/cache.log</value>
                        </property>
                        <property>
                          <name>wrapper.logfile.format</name>
                          <value>M</value>
                        </property>
                        <property>
                          <name>wrapper.logfile.maxsize</name>
                          <value>10m</value>
                        </property>
                        <property>
                          <name>wrapper.logfile.maxfiles</name>
                          <value>5</value>
                        </property>
                        <property>
                          <name>wrapper.logfile.purge.pattern</name>
                          <value>%APP_BASE%/../../logs/cache.log.*</value>
                        </property>
                        <property>
                          <name>wrapper.logfile.purge.sort</name>
                          <value>TIMES</value>
                        </property>
                        <property>
                          <name>wrapper.on_exit.default</name>
                          <value>RESTART</value>
                        </property>
                        <property>
                          <name>wrapper.restart.delay</name>
                          <value>5</value>
                        </property>
                        <property>
                          <name>wrapper.max_failed_invocations</name>
                          <value>10</value>
                        </property>
                        <property>
                          <name>wrapper.ping.timeout</name>
                          <value>0</value>
                        </property>
                        <property>
                          <name>wrapper.java.additional.1</name>
                          <value>-Djava.rmi.server.hostname=${hostname}</value>
                        </property>
                      </configuration>
                    </generatorConfiguration>
                  </generatorConfigurations>
                </daemon>
              </daemons>
            </configuration>
            <executions>
              <execution>
                <goals>
                  <goal>generate-daemons</goal>
                  <goal>create-repository</goal>
                </goals>
              </execution>
            </executions>
          </plugin>

          <plugin>
            <artifactId>maven-assembly-plugin</artifactId>
            <version>2.1</version>
            <executions>
              <execution>
                <phase>post-integration-test</phase>
                <goals>
                  <goal>directory-inline</goal>
                  <goal>attached</goal>
                </goals>
              </execution>
            </executions>
            <configuration>
              <descriptors>
                <descriptor>src/main/assembly/standalone.xml</descriptor>
              </descriptors>
              <tarLongFileMode>gnu</tarLongFileMode>
            </configuration>
          </plugin>
        </plugins>
      </build>
    </profile>
    <profile>
      <id>skip-uit-tests</id>
      <activation>
        <activeByDefault>true</activeByDefault>
      </activation>
      <build>
        <plugins>
          <plugin>
            <groupId>org.apache.maven.plugins</groupId>
            <artifactId>maven-surefire-plugin</artifactId>
            <configuration>
              <excludes>
                <exclude>logogin/app/uit/*</exclude>
                <!-- avoid running inner classes -->
                <exclude>**/*$*.java</exclude>
              </excludes>
            </configuration>
          </plugin>
        </plugins>
      </build>
    </profile>
    <profile>
      <!-- runs uit tests which are not run be default -->
      <!-- mvn -Drun.uit.tests=true integration-test -->
      <id>run-uit-tests</id>
      <activation>
        <activeByDefault>false</activeByDefault>
        <property>
          <name>run.uit.tests</name>
          <value>true</value>
        </property>
      </activation>
      <build>
        <plugins>
          <plugin>
            <groupId>org.apache.maven.plugins</groupId>
            <artifactId>maven-surefire-plugin</artifactId>
            <configuration>
              <includes>
                <include>logogin/uit/*</include>
              </includes>
              <skip>true</skip>
            </configuration>
            <executions>
              <execution>
                <id>uit-tests</id>
                <phase>integration-test</phase>
                <goals>
                  <goal>test</goal>
                </goals>
                <configuration>
                  <skip>false</skip>
                </configuration>
              </execution>
            </executions>
          </plugin>
        </plugins>
      </build>
    </profile>
  </profiles>
</project>
